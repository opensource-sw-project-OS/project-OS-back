<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚ ì§œ/ê¸ˆì•¡ ì¶”ì¶œ</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { max-width: 300px; margin-top: 10px; display: none; }
    #result, #categoryOutput, #extracted { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 15px; }
  </style>
</head>
<body>
  <h2>ğŸ§¾ ì§€ì¶œ ì‚¬ì§„ì—ì„œ ë‚ ì§œ/ê¸ˆì•¡ ì¶”ì¶œ</h2>

  <input type="file" id="upload" accept="image/*" />
  <br><br>
  <img id="preview" />

  <br>
  <label>ë¶„ì•¼ ì„ íƒ:</label>
  <select id="category">
    <option value="ì‹ë‹¹">ì‹ë‹¹</option>
    <option value="ì¹´í˜">ì¹´í˜</option>
    <option value="ì—¬ê°€">ì—¬ê°€</option>
    <option value="ì‡¼í•‘">ì‡¼í•‘</option>
    <option value="êµí†µ">êµí†µ</option>
    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
  </select>

  <br><br>
  <button onclick="runOCR()">OCR ì‹¤í–‰</button>

  <div id="categoryOutput">ì„ íƒ ë¶„ì•¼: ì—†ìŒ</div>
  <div id="result">OCR ê²°ê³¼</div>
  <div id="extracted">ğŸ“Š ë‚ ì§œ / í•©ê³„ ê¸ˆì•¡ ì¶”ì¶œ ê²°ê³¼</div>


  <canvas id="processedCanvas"></canvas>


  <script async src="https://docs.opencv.org/3.4.0/opencv.js" type="text/javascript"></script>
  <script>
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const result = document.getElementById('result');
    const categoryOutput = document.getElementById('categoryOutput');
    const extracted = document.getElementById('extracted');

    let imageData = null;
    let proc_image = null;

    upload.addEventListener('change', () => {
      const file = upload.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        imageData = reader.result;
        preview.src = imageData;
        preview.style.display = 'block';
        console.log(imageData);
      };
      reader.readAsDataURL(file);
    });

    const processedCanvas = document.getElementById('processedCanvas');
    function imgProc(imageData) {   
        var Module = {
            onRuntimeInitialized() {
                console.log('OpenCV.js is ready.');
            }
        };
      const canvasInput = imageData;
      

      let src = cv.imread(preview);
      let gray = new cv.Mat();
      let dst = new cv.Mat();
      let blurred = new cv.Mat();
      let sharp = new cv.Mat();

      //cv.imshow(processedCanvas, src)

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);    // gray ë³€ê²½
      //cv.bilateralFilter(gray, blurred, 9, 75, 75); // ë¸”ëŸ¬ ì ìš©
      //const kernel = cv.matFromArray(3, 3, cv.CV_32F, [-1, -1, -1, -1, 9, -1, -1, -1, -1]);  // ìƒ¤í”„ë‹ ì ìš©ìš©
      //cv.filter2D(blurred, sharp, cv.CV_8U, kernel); // í•„í„° ì ìš©ìš©
      //cv.threshold(gray, dst, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);  // ì´ì§„ ë§ˆìŠ¤í¬ ìƒì„±ì„±
      cv.imshow(processedCanvas, gray)

      src.delete();
      dst.delete();
      gray.delete();
      blurred.delete();
      sharp.delete();
    }

    function runOCR() {
      const category = document.getElementById('category').value;

      if (!imageData) {
        alert("ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.");
        return;
      }

      imgProc(imageData);                                      // ì¶”ê°€í•œ ë¶€ë¶„

      result.innerText = "OCR ì¸ì‹ ì¤‘";
      categoryOutput.innerText = `ì„ íƒ ë¶„ì•¼: ${category}`;
      extracted.innerText = 'ë‚ ì§œ / í•©ê³„ ê¸ˆì•¡ ì¶”ì¶œ ê²°ê³¼:\n(ì¶”ì¶œ ì¤‘...)';

      Tesseract.recognize(
        processedCanvas,                                      // ì¶”ê°€í•œ ë¶€ë¶„
        'kor',	// í•œê¸€ ì¸ì‹ ì„¤ì •
        {
          langPath: 'https://tessdata.projectnaptha.com/4.0.0/',
          logger: m => console.log(m)
        }
      ).then(({ data: { text } }) => {
        result.innerText = `ğŸ“ OCR ê²°ê³¼:\n\n${text}`;

        // ë‚ ì§œ ì •ê·œì‹ ì¶”ì¶œ (ì˜ˆ: yyyy.mm.dd ë˜ëŠ” yyyy/mm/dd)
        const dateMatch = text.match(/\d{4}[.\-/]\d{1,2}[.\-/]\d{1,2}/);
        const date = dateMatch ? dateMatch[0] : 'ë‚ ì§œ ë¯¸ì¸ì‹';

        // 'í•©ê³„','ì´ì•¡','ì´í•©ê³„' ë’¤ì— ë‚˜ì˜¤ëŠ” ìˆ«ì ì¶”ì¶œ
        const totalMatch = text.match(/(í•©ê³„|ì´ì•¡|ì´í•©ê³„)[^\d]*(â‚©?\s?\d{1,3}(,\d{3})*(ì›)?)/);
        const amount = totalMatch ? totalMatch[2] : 'ê¸ˆì•¡ ë¯¸ì¸ì‹';

        extracted.innerText = `ë‚ ì§œ: ${date}\ní•©ê³„ ê¸ˆì•¡: ${amount}`;
      }).catch(err => {
        result.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`;
        extracted.innerText = 'âŒ ì¶”ì¶œ ì‹¤íŒ¨';
      });
    }
  </script>
</body>
</html>